# see https://github.com/dorny/paths-filter
on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
    
name: R-CMD-check-all

jobs:
    changes:
      runs-on: ubuntu-latest
      permissions:
        pull-requests: read
      outputs:
        # Expose matched filters as job 'packages' output variable
        packages: ${{ steps.filter.outputs.changes }}
      steps:
      # For pull requests it's not necessary to checkout the code
      - uses: actions/checkout@v2
      - uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            testpkg01: testpkg01
            testpkg02: testpkg02

    # JOB to build and test each of modified packages
    build:
      needs: changes
      strategy:
        matrix:
          # Parse JSON array containing names of all filters matching any of changed files
          # e.g. ['package1', 'package2'] if both package folders contains changes
          package: ${{ fromJSON(needs.changes.outputs.packages) }}
      uses: ./.github/workflows/R-CMD-check.yaml
      secrets: inherit
      with: 
        pkg-path: ${{ matrix.package }}
