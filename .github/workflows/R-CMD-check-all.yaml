# see https://github.com/dorny/paths-filter
on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
    
jobs:
    changes:
      runs-on: ubuntu-latest
      permissions:
        pull-requests: read
      outputs:
        # Expose matched filters as job 'packages' output variable
        packages: ${{ steps.filter.outputs.changes }}
      steps:
      # For pull requests it's not necessary to checkout the code
      - uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            testpkg01: testpkg01
            testpkg02: testpkg02

      # JOB to build and test each of modified packages
      build:
        needs: changes
        secrets: inherit
        strategy:
          matrix:
            # Parse JSON array containing names of all filters matching any of changed files
            # e.g. ['package1', 'package2'] if both package folders contains changes
            package: ${{ fromJSON(needs.changes.outputs.packages) }}
        runs-on: ubuntu-20.04
        steps:
          - uses: ./.github/workflows/R-CMD-check.yaml
            with: 
              pkg-path: ${{ matrix.package }}
